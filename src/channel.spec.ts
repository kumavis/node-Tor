import test from 'ava';
import { Connection, performHandshake } from './channel'

const b = (s: string) => Buffer.from(s, 'hex')

const fixtureKeyInfo = {
  privid: b('2d2d2d2d2d424547494e2050524956415445204b45592d2d2d2d2d0a4d494943655149424144414e42676b71686b6947397730424151454641415343416d4d7767674a6641674541416f4742414c7934756c4e6a4c437730356749720a44424a5a66635431786e2b374545727a496a756e77325866426a51553349353052425a584652724d7356555964334250635665476930576f59526e384a2b67730a6545507858785a457a67526c3336345677707159726c5763364f4473695632487445337136453476526a4c6a5441664947724476334a63522f6e4239744974780a63496a6f657236694769436d4150394a2f743970714f65577570684c41674d424141454367594541696165497153684f59525259725434752b50647a794957700a4f79503856313850476b70644f57493743535171574849763838656a4b6b41694854725362415a575777785662414c4d69514b6e4c532b3672587853365133450a6e705179763753505462434361466954386a3553576e5a6437755732693069666539414d3063345a625442316f415a3950624532746b654146773776506264770a79744f3878614a47336676365a5469755a326b435151443150796e7a6e306d3648436d70674a695a336f4b3833514f67386a7a506a34444c4d666c786c3053470a4a3555714e6c4c39704559626d6f6e4979737671546d574d7a322b6b754b5a674c566a6f644d7a432f4d7250416b4541785038564c644851364a58376f6532420a366f5258616d6d587a3342645951733979432f6c39394933764844434e6437386e336e3452416a694268683779565373342b474557747a787a556d384664374e0a3579724a78514a42414d325863666646704f7a634279454e714e2f30354f796d36772f566770304e31413644696e56724e6771777a42396a41786557797838410a346c6a74695279584e424a6a4931695859774a6c6759373975316f4b79596b43515143536b32577a79516b5339663363467a6479516e5130686b72686d7936760a7455694c2b692b33504741695178674f4d314e756162647a4439543153695259776a733939352b6561415532685357416446357149576b74416b45413248624e0a7965427039757551504f753258335250577536677569684535674230312b52597643596b7a4a387064627679594d474a774e4d6875597131336c665077744b480a443961313778784f706a394d5236417638413d3d0a2d2d2d2d2d454e442050524956415445204b45592d2d2d2d2d0a'),
  pubid: b('2d2d2d2d2d424547494e20525341205055424c4943204b45592d2d2d2d2d0a4d49474a416f4742414c7934756c4e6a4c4377303567497244424a5a66635431786e2b374545727a496a756e77325866426a51553349353052425a584652724d0a7356555964334250635665476930576f59526e384a2b67736545507858785a457a67526c3336345677707159726c5763364f44736956324874453371364534760a526a4c6a5441664947724476334a63522f6e42397449747863496a6f657236694769436d4150394a2f743970714f65577570684c41674d424141453d0a2d2d2d2d2d454e4420525341205055424c4943204b45592d2d2d2d2d0a'),
  pubkey: b('2d2d2d2d2d424547494e20525341205055424c4943204b45592d2d2d2d2d0a4d49474a416f4742414f7574723457354c7479762f35393457386f4877325270706a6c2b5951544f516e3141466436506b552b394f436c2b6b336a36635455770a4a334b656254766e664e58434f594274723633666b33634c732b76705a54756755687656756f7079584163462b4178746c4f57554a5449636b49744e644e356f0a562f684d43732b4f5a4b52304e7256686741547241732f566176456d4a3641796857706573764d575941544b7369536c5344627041674d424141453d0a2d2d2d2d2d454e4420525341205055424c4943204b45592d2d2d2d2d0a'),
  privkey: b('2d2d2d2d2d424547494e2050524956415445204b45592d2d2d2d2d0a4d494943647749424144414e42676b71686b6947397730424151454641415343416d457767674a6441674541416f4742414f7574723457354c7479762f3539340a57386f4877325270706a6c2b5951544f516e3141466436506b552b394f436c2b6b336a36635455774a334b656254766e664e58434f594274723633666b33634c0a732b76705a54756755687656756f7079584163462b4178746c4f57554a5449636b49744e644e356f562f684d43732b4f5a4b52304e7256686741547241732f560a6176456d4a3641796857706573764d575941544b7369536c5344627041674d424141454367594541694c2f59423853693332537a38306b344957734e776862580a5836626f446f7a4c34626373755634656c2b455956474e676d4b4c67793162736e4d4932616272784957733453442f633377764b6d686e4e525562412b4a486d0a503737537263372f7a4a443664576245574f7a7274732f72424a62484f4b4a6a3647454c32565a6732376c4471387a2b4d386a5766587878624f5152725873530a4e68475570705562445a7441516d756e654b30435151443962394d346356394b6462465343554c334f63713063306b583955562f54384d6979774b735a7a7a750a3536386b4b65426968352f734b31694b3764707339745754436954654d664571794e536e6c75746678394c72416b454137672f68334d7a495a684b737a3372730a2b5042323661647a5462366f34654339584c455a5253695777763365714a4c30556f2f765259327042576c636b4b2f4c65524252666b416d5665744f6d726a7a0a69706d6765774a414842636f386a69657430495552574f42614b57664d69455647504b326f5558562b79564652706171796c416a7558357177494548324d56310a4b7644794a4f4733436e5531594f746f4c3758533345422b466a2b7677514a42414c53354b65584e4d48554d794650614a667631304e41675a74416d5a5637550a6c657a414a55627a515542574b616f667059726e3665554c58627a563934642f6253424332787255364556686c524b7752584a366e66454351456231415264430a512b76544b366e6b6e482f527248506c664379657775795377786277754f514e6c5a704563754f3167442b78784f53653956444b376f4f4e2b387649364f496a0a38434a596c773330427938412b68453d0a2d2d2d2d2d454e442050524956415445204b45592d2d2d2d2d0a'),
}

const v3HandshakeFixture = {
  clientHello: b('00000700020003'),
  serverHello: b('000007000600030004000500008105af0501024930820245308201aea003020102020867d58b28a5f739f1300d06092a864886f70d01010b0500301f311d301b06035504030c147777772e7967666e7861336f796c78742e636f6d301e170d3233303430343030303030305a170d3234303232393030303030305a30273125302306035504030c1c7777772e36686c7a656f68337863787169626464367667712e6e657430820122300d06092a864886f70d01010105000382010f003082010a0282010100d04f21827f70d382e2fedc96520b099d5fbdc35e55010acd75476dbfaacc0f1c63d157d245049016606ab3b0d4b6809780d1bad189e1a1b5b0766bfb52963662b6e66ff6d4a09db709242d97de2ca0043ca459151a2b3f5b3a7cdaa560baca98f1940da21351c3aaf6d08090d3477b2f73fd5f6aae8d1cd875c7f8c307126f76c888a4df8c975124aab5ad1f144f50ad849c5debe167667571a300c6ebd7cc6ccd82c3b8923fd483e33a77b15cd3920e33fb1e509e37f1b68daa66bcfcfd6506e01ea6ebfe698b5c35265c64bab04d7ae153de17471cc28699c82276e38625fe1508e5094bb7e007f5428266c972a9910e03bc5de6de979b63e9e7d267cd71ad0203010001300d06092a864886f70d01010b05000381810058cc4584c5c9311f4687b8d2eb9e8f828e0ba06e1a859d921a219e91c590fe67e378f206e2b10498ffbcb28d4f4544a947c05b4793dc5569ce23b47e6e8f7d77cca047745b5458792e116792ca56a5d1f4bc832ea53a0103d372b5675f454cbcc03937a1b13d4b31137fb06f893a44be085dee97276b9fd498acf071696dc2d40201bd308201b930820122a0030201020208761a96b0be50d8d4300d06092a864886f70d01010b0500301f311d301b06035504030c147777772e7967666e7861336f796c78742e636f6d301e170d3232303932383030303030305a170d3233303932383030303030305a301f311d301b06035504030c147777772e7967666e7861336f796c78742e636f6d30819f300d06092a864886f70d010101050003818d0030818902818100d1b298f5d0d3a879a039484de926fd75ca613ff20dea69f70310f60b74d52d4c5c27e3148d012cc73133b013bcee0ae6f3833d101e8acd4a9e880ec2bb57283e5c53bb36842ab8934c7083ca4ae2b83bd7109ef7f0c5ac758dbcdec3a46c20c80d392a6a13248e48682ad3fa0e6e7c13b8a90b8bf9d4788e6315ec47e85124b50203010001300d06092a864886f70d01010b050003818100622c76576d3588a375be8d94d2291e8a1b2400cca739370aae026ab5181d3ec75398e55f2abc29b497c1a54c725ca6538c5ab7c1d960c18b39bdb78e4b6271a6609b7e24a24a054c04fd2ff4dad4f740bf7a6bd2021a0c5eb9a111383a4180f7873131bc469d88081f511bdff6327b60a6c0ea19eb1255d5fa320efa1e1e28c204008c01040007286a014339d4d20457ec8328ebabbb11f3db77f7aaea390fd37a8e105e2e62b126c318010020040078d5dcbcbaaed604ed4174b883496e4a75864fe336d8989abb9f033d9d13ad1fc9160959c8ac54eb98ab429882020d17de9e3721756fbdcf1e0b98771df7876c03bdf9afe62c563db507c60ce93c8f88dd09aa2f0ad52d5602ceaa3be3d37c030500680105000724f503a35f907f7a5423968aa8edc88f15169f792951da9a8695c464ca6379396a7d16004e187457f376bcfcaf64cc6634a4e3866c0ad0bdf77d39490f7ce2573aa46382060630f62c1f1b9ebf781c1751b1de37ff338c95f0c1b4231acb04bcda81100d0700a578d5dcbcbaaed604ed4174b883496e4a75864fe336d8989abb9f033d9d13ad1f000733958061ea1da5b68de177b917d4e4aecce959ecbb115d4bcf31c91eb6f5a4c6b66f6814755250c668bf2454fc478e914f6aa6a76fff608c590575c8338501f727d835198e9ce24641d9baf896e9027eeea6eeabc649f13d6ef0e8c175fb79fc53ef6705b71c0fe751d6b812fec994f174edd0b2c40c0a67378072a2e344499f03e58f00008200269c7f63104fa11424e5b53099b754af443ceb2bbeee0deabe3d7b3b102f2b961e0002000100030000086475197b040426f0e25b0204045db49d9a06102a0011580003000000000000000002ae000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000'),
  peerCert: b('30820245308201aea003020102020867d58b28a5f739f1300d06092a864886f70d01010b0500301f311d301b06035504030c147777772e7967666e7861336f796c78742e636f6d301e170d3233303430343030303030305a170d3234303232393030303030305a30273125302306035504030c1c7777772e36686c7a656f68337863787169626464367667712e6e657430820122300d06092a864886f70d01010105000382010f003082010a0282010100d04f21827f70d382e2fedc96520b099d5fbdc35e55010acd75476dbfaacc0f1c63d157d245049016606ab3b0d4b6809780d1bad189e1a1b5b0766bfb52963662b6e66ff6d4a09db709242d97de2ca0043ca459151a2b3f5b3a7cdaa560baca98f1940da21351c3aaf6d08090d3477b2f73fd5f6aae8d1cd875c7f8c307126f76c888a4df8c975124aab5ad1f144f50ad849c5debe167667571a300c6ebd7cc6ccd82c3b8923fd483e33a77b15cd3920e33fb1e509e37f1b68daa66bcfcfd6506e01ea6ebfe698b5c35265c64bab04d7ae153de17471cc28699c82276e38625fe1508e5094bb7e007f5428266c972a9910e03bc5de6de979b63e9e7d267cd71ad0203010001300d06092a864886f70d01010b05000381810058cc4584c5c9311f4687b8d2eb9e8f828e0ba06e1a859d921a219e91c590fe67e378f206e2b10498ffbcb28d4f4544a947c05b4793dc5569ce23b47e6e8f7d77cca047745b5458792e116792ca56a5d1f4bc832ea53a0103d372b5675f454cbcc03937a1b13d4b31137fb06f893a44be085dee97276b9fd498acf071696dc2d4'),
}

const v5HandshakeFixture = {
  clientHello: b('0000070006000300040005'),
  serverHello: b('0000070006000300040005000000008105af0501024930820245308201aea003020102020867d58b28a5f739f1300d06092a864886f70d01010b0500301f311d301b06035504030c147777772e7967666e7861336f796c78742e636f6d301e170d3233303430343030303030305a170d3234303232393030303030305a30273125302306035504030c1c7777772e36686c7a656f68337863787169626464367667712e6e657430820122300d06092a864886f70d01010105000382010f003082010a0282010100d04f21827f70d382e2fedc96520b099d5fbdc35e55010acd75476dbfaacc0f1c63d157d245049016606ab3b0d4b6809780d1bad189e1a1b5b0766bfb52963662b6e66ff6d4a09db709242d97de2ca0043ca459151a2b3f5b3a7cdaa560baca98f1940da21351c3aaf6d08090d3477b2f73fd5f6aae8d1cd875c7f8c307126f76c888a4df8c975124aab5ad1f144f50ad849c5debe167667571a300c6ebd7cc6ccd82c3b8923fd483e33a77b15cd3920e33fb1e509e37f1b68daa66bcfcfd6506e01ea6ebfe698b5c35265c64bab04d7ae153de17471cc28699c82276e38625fe1508e5094bb7e007f5428266c972a9910e03bc5de6de979b63e9e7d267cd71ad0203010001300d06092a864886f70d01010b05000381810058cc4584c5c9311f4687b8d2eb9e8f828e0ba06e1a859d921a219e91c590fe67e378f206e2b10498ffbcb28d4f4544a947c05b4793dc5569ce23b47e6e8f7d77cca047745b5458792e116792ca56a5d1f4bc832ea53a0103d372b5675f454cbcc03937a1b13d4b31137fb06f893a44be085dee97276b9fd498acf071696dc2d40201bd308201b930820122a0030201020208761a96b0be50d8d4300d06092a864886f70d01010b0500301f311d301b06035504030c147777772e7967666e7861336f796c78742e636f6d301e170d3232303932383030303030305a170d3233303932383030303030305a301f311d301b06035504030c147777772e7967666e7861336f796c78742e636f6d30819f300d06092a864886f70d010101050003818d0030818902818100d1b298f5d0d3a879a039484de926fd75ca613ff20dea69f70310f60b74d52d4c5c27e3148d012cc73133b013bcee0ae6f3833d101e8acd4a9e880ec2bb57283e5c53bb36842ab8934c7083ca4ae2b83bd7109ef7f0c5ac758dbcdec3a46c20c80d392a6a13248e48682ad3fa0e6e7c13b8a90b8bf9d4788e6315ec47e85124b50203010001300d06092a864886f70d01010b050003818100622c76576d3588a375be8d94d2291e8a1b2400cca739370aae026ab5181d3ec75398e55f2abc29b497c1a54c725ca6538c5ab7c1d960c18b39bdb78e4b6271a6609b7e24a24a054c04fd2ff4dad4f740bf7a6bd2021a0c5eb9a111383a4180f7873131bc469d88081f511bdff6327b60a6c0ea19eb1255d5fa320efa1e1e28c204008c01040007286a014339d4d20457ec8328ebabbb11f3db77f7aaea390fd37a8e105e2e62b126c318010020040078d5dcbcbaaed604ed4174b883496e4a75864fe336d8989abb9f033d9d13ad1fc9160959c8ac54eb98ab429882020d17de9e3721756fbdcf1e0b98771df7876c03bdf9afe62c563db507c60ce93c8f88dd09aa2f0ad52d5602ceaa3be3d37c030500680105000724f503a35f907f7a5423968aa8edc88f15169f792951da9a8695c464ca6379396a7d16004e187457f376bcfcaf64cc6634a4e3866c0ad0bdf77d39490f7ce2573aa46382060630f62c1f1b9ebf781c1751b1de37ff338c95f0c1b4231acb04bcda81100d0700a578d5dcbcbaaed604ed4174b883496e4a75864fe336d8989abb9f033d9d13ad1f000733958061ea1da5b68de177b917d4e4aecce959ecbb115d4bcf31c91eb6f5a4c6b66f6814755250c668bf2454fc478e914f6aa6a76fff608c590575c8338501f727d835198e9ce24641d9baf896e9027eeea6eeabc649f13d6ef0e8c175fb79fc53ef6705b71c0fe751d6b812fec994f174edd0b2c40c0a67378072a2e344499f03e58f00000000820026f124b4e094b9eff84cb17ddb1376528215671178ac34798e4e727a471689908b00020001000300000000086475209e040426f0e25b0204045db49d9a06102a0011580003000000000000000002ae000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000'),
  peerCert: b('30820245308201aea003020102020867d58b28a5f739f1300d06092a864886f70d01010b0500301f311d301b06035504030c147777772e7967666e7861336f796c78742e636f6d301e170d3233303430343030303030305a170d3234303232393030303030305a30273125302306035504030c1c7777772e36686c7a656f68337863787169626464367667712e6e657430820122300d06092a864886f70d01010105000382010f003082010a0282010100d04f21827f70d382e2fedc96520b099d5fbdc35e55010acd75476dbfaacc0f1c63d157d245049016606ab3b0d4b6809780d1bad189e1a1b5b0766bfb52963662b6e66ff6d4a09db709242d97de2ca0043ca459151a2b3f5b3a7cdaa560baca98f1940da21351c3aaf6d08090d3477b2f73fd5f6aae8d1cd875c7f8c307126f76c888a4df8c975124aab5ad1f144f50ad849c5debe167667571a300c6ebd7cc6ccd82c3b8923fd483e33a77b15cd3920e33fb1e509e37f1b68daa66bcfcfd6506e01ea6ebfe698b5c35265c64bab04d7ae153de17471cc28699c82276e38625fe1508e5094bb7e007f5428266c972a9910e03bc5de6de979b63e9e7d267cd71ad0203010001300d06092a864886f70d01010b05000381810058cc4584c5c9311f4687b8d2eb9e8f828e0ba06e1a859d921a219e91c590fe67e378f206e2b10498ffbcb28d4f4544a947c05b4793dc5569ce23b47e6e8f7d77cca047745b5458792e116792ca56a5d1f4bc832ea53a0103d372b5675f454cbcc03937a1b13d4b31137fb06f893a44be085dee97276b9fd498acf071696dc2d4'),
}

test.failing('v3 handshake', async t => {
  const connection = new Connection({ isInitiator: true })
  const outboundTraffic: Buffer[] = []
  connection.sendData = (data) => outboundTraffic.push(data)
  const supportedVersions = [3]
  const handshakeCompleteP = performHandshake(connection, fixtureKeyInfo, v3HandshakeFixture.peerCert, supportedVersions)
  connection.onData(v3HandshakeFixture.serverHello)
  await handshakeCompleteP
})

test.failing('v5 handshake', async t => {
  const connection = new Connection({ isInitiator: true })
  const outboundTraffic: Buffer[] = []
  connection.sendData = (data) => outboundTraffic.push(data)
  const handshakeCompleteP = performHandshake(connection, fixtureKeyInfo, v5HandshakeFixture.peerCert)
  connection.onData(v5HandshakeFixture.serverHello)
  await handshakeCompleteP
})
